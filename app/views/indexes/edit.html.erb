<h1>Edit index</h1>

<% form_for :index, :url => { :action => "update" } do |f| %>
  <%= f.error_messages %>
  <%= hidden_field_tag :id, @index %>

  <p>
    <%= f.label :name %><br />
    <%= f.text_field :index_name %>
  </p>
  <p>
    <%= f.label :title %><br />
    <%= f.text_field :index_title %>
  </p>
  <p>
    <%= f.label :context %><br />
    <%= f.select :context_index_context, @contexts, :selected => @index.context_index_context.first ? @index.context_index_context.first.uri : nil %>
  </p>

  <p>
    <%= f.submit 'Save' %>
  </p>
<% end %>

<script type="text/javascript">
 function open_index_attributes_window(id) {
    var options_hash = array_options_hash(<%= SHDM::Index.find_all.map{|v| [CGI::escape(v.uri), v.index_name.first]}.to_json %>);
   // alert(options_hash.toSource);
    var elements = [
                    { "name" : "navigation_attribute_name", "caption" : "Name" },
                    { "name" : "index_navigation_attribute_index", "caption" : "Index", "type" : "select", "options": options_hash },
                    { "name" : "navigation_attribute_index_position", "caption" : "Position" },
                    { "name" : "id", "type" : "hidden", "class" : "hidden"}
                    ];
    create_window_modal(id, '/contexts/get_resource_attributes/','/indexes/index_attributes_post_data', {parent:'<%= CGI::escape(@index.uri) %>'}, 'Parameters', elements, function() {$("#index_attributes").trigger("reloadGrid");});
  }

</script>

<%=jqgrid("Index Attributes", "index_attributes", "/indexes/index_attributes/#{CGI::escape(@index.uri)}",
	[
		{ :field => "id", :label => "ID", :width => 1, :resizable => false },
		{ :field => "navigation_attribute_name", :label => "Name", :editable => true, :width => 300, :align => 'center' },
		{ :field => "index_navigation_attribute_index", :label => "Index", :editable => true, :width => 350 ,:edittype => "select",
		  :editoptions => { :value => SHDM::Index.find_all.map{|v| [CGI::escape(v.uri), v.index_name.first]} } },
 		{ :field => "navigation_attribute_index_position", :label => "Position", :editable => true, :width => 50, :align => 'center' }
	],
	{ 
	  :selection_handler => "open_index_attributes_window", :direct_selection => false, :delete => true,
    :add => true, :inline_edit => false, :delete => true, :search => false, :hiddengrid => @index.index_index_attributes.to_a.empty? ? 'true' : 'false', :height => 70,
	  :edit_url => "/indexes/index_attributes_post_data?parent=#{CGI::escape(@index.uri)}",
		:subgrid => { 
					
					:url => "/indexes/index_navigation_attribute_index_parameters",
					:columns => [
						{ :field => "id", :label => "ID", :width => 1, :resizable => false },
						{ :field => "navigation_attribute_parameter_name", :label => "Name", :editable => true },
						{ :field => "navigation_attribute_parameter_value_expression", :label => "Value expression", :editable => true }
				    ],
					:add => true, 
					:edit => true, 
					:delete => true, 
					:search => false, 
					:inline_edit => true,
					:edit_url => "/indexes/index_navigation_attribute_index_parameters_post_data"
		}
	}
)%>
<p><a href='javascript:void(0)' onclick='open_index_attributes_window()'>New Index Attribute</a></p>
<br />
<%=jqgrid("Context Anchor Attributes", "context_anchor_attributes", "/indexes/context_anchor_attributes/#{CGI::escape(@index.uri)}",
	[
		{ :field => "id", :label => "ID", :width => 1, :resizable => false },
		{ :field => "navigation_attribute_name", :label => "Name", :editable => true, :width => 100, :align => 'center' },
		{ :field => "context_anchor_navigation_attribute_label_expression", :label => "Label expression", :editable => true, :width => 300, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 40 } },
		{ :field => "context_anchor_navigation_attribute_target_context", :label => "Target context", :editable => true, :width => 100 ,:edittype => "select",
		  :editoptions => { :value => SHDM::Context.find_all.map{|v| [CGI::escape(v.uri), v.context_name.first]} } },
  	{ :field => "context_anchor_navigation_attribute_target_node_expression", :label => "Target node expression", :editable => true, :width => 150, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 40 } },
		{ :field => "navigation_attribute_index_position", :label => "Position", :editable => true, :width => 50, :align => 'center' }
	],
	{ 
	  :add => true, :inline_edit => true, :delete => true, :search => false, :hiddengrid => @index.context_anchor_attributes.to_a.empty? ? 'true' : 'false', :height => 150,
	  :edit_url => "/indexes/context_anchor_attributes_post_data?parent=#{CGI::escape(@index.uri)}",
		:subgrid => { 
					
					:url => "/indexes/navigation_attribute_context_parameters",
					:columns => [
						{ :field => "id", :label => "ID", :width => 1, :resizable => false },
						{ :field => "navigation_attribute_parameter_name", :label => "Name", :editable => true },
						{ :field => "navigation_attribute_parameter_value_expression", :label => "Value expression", :editable => true }
				    ],
					:add => true, 
					:edit => true, 
					:delete => true, 
					:search => false, 
					:inline_edit => true,
					:edit_url => "/indexes/navigation_attribute_context_parameters_post_data"
				  }
	}
)%>
<br/>
<%=jqgrid("Index Anchor Attributes", "index_anchor_attributes", "/indexes/index_anchor_attributes/#{CGI::escape(@index.uri)}",
	[
		{ :field => "id", :label => "ID", :width => 1, :resizable => false },
		{ :field => "navigation_attribute_name", :label => "Name", :editable => true, :width => 150, :align => 'center' },
		{ :field => "index_anchor_navigation_attribute_label_expression", :label => "Label expression", :editable => true, :width => 300, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 40 } },
		{ :field => "index_anchor_navigation_attribute_target_index", :label => "Target index", :editable => true, :width => 200 ,:edittype => "select",
		  :editoptions => { :value => SHDM::Index.find_all.map{|v| [CGI::escape(v.uri), v.index_name.first]} } },

		
		{ :field => "navigation_attribute_index_position", :label => "Position", :editable => true, :width => 50, :align => 'center' }
	],
	{ 
	  :add => true, :inline_edit => true, :delete => true, :search => false, :hiddengrid => @index.index_anchor_attributes.to_a.empty? ? 'true' : 'false',:height => 150,
	  :edit_url => "/indexes/index_anchor_attributes_post_data?parent=#{CGI::escape(@index.uri)}",
	  :subgrid => { 
					
					:url => "/indexes/navigation_attribute_index_parameters",
					:columns => [
						{ :field => "id", :label => "ID", :width => 1, :resizable => false },
						{ :field => "navigation_attribute_parameter_name", :label => "Name", :editable => true },
						{ :field => "navigation_attribute_parameter_value_expression", :label => "Value expression", :editable => true }
				    ],
					:add => true, 
					:edit => true, 
					:delete => true, 
					:search => false, 
					:inline_edit => true,
					:edit_url => "/indexes/navigation_attribute_index_parameters_post_data"
				  }
	}
)%>
<br/>
<%=jqgrid("Computed Attributes", "computed_attributes", "/indexes/computed_attributes/#{CGI::escape(@index.uri)}",
	[
		{ :field => "id", :label => "ID", :width => 1, :resizable => false },
		{ :field => "navigation_attribute_name", :label => "Name", :editable => true, :width => 220, :align => 'center' },
		{ :field => "computed_navigation_attribute_value_expression", :label => "Value expression", :editable => true, :width => 450, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 70 } },
		{ :field => "navigation_attribute_index_position", :label => "Position", :editable => true, :width => 50, :align => 'center' }
	],
	{ :add => true, :edit => true, :inline_edit => true, :delete => true, :search => false, :hiddengrid => @index.computed_attributes.to_a.empty? ? 'true' : 'false', :height => 150,
	  :edit_url => "/indexes/computed_attributes_post_data?parent=#{CGI::escape(@index.uri)}" }	
)%>
<br />
<%=jqgrid("Pre Conditions", "pre_conditions", "/indexes/pre_conditions/#{CGI::escape(@index.uri)}",
	[
		{ :field => "id", :label => "ID", :width => 1, :resizable => false },
		{ :field => "pre_condition_name", :label => "Name", :editable => true, :width => 220, :align => 'center' },
		{ :field => "pre_condition_expression", :label => "Expression",	:editable => true, :width => 250, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 40 } },
		{ :field => "pre_condition_failure_handling", :label => "Failure handling",	:editable => true, :width => 250, :edittype => "textarea", :editoptions => { :rows => 5, :cols => 40 } }
	],
	{ :add => true, :edit => true, :inline_edit => true, :delete => true, :search => false, :hiddengrid => @index.index_pre_conditions.to_a.empty? ? 'true' : 'false',:height => 150,
	  :edit_url => "/indexes/pre_conditions_post_data?parent=#{CGI::escape(@index.uri)}" }
)%>
<br/>
<%= link_to 'Back', indexes_path %>